<% extend("../app.ejs") %>

<!-- Payment Section -->
<section id="payment-section">
    <div class="container">
        <div class="row">
            <div class="col-12 mt-5 d-flex justify-content-center">
                <h2>Complete Your Payment</h2>
            </div>
            <div class="col-12 d-flex justify-content-center mt-3">
                <!-- Google Pay Button -->
                <div id="google-pay-button-container"></div>
            </div>
        </div>
    </div>
</section>

<!-- Success Section -->
<section id="success-section" style="display: none;">
    <div class="container">
        <div class="container">
            <div class="row">
                <div class="col-8 mx-auto">
                    <h2>Đặt lịch thành công!</h2>
                    <hr>
                    <div class="booking-success row">
                        <div class="right-booking col-3 d-flex flex-column">
                            <img style="object-fit: cover;" src="/images/users/<%= patient.getDataValue('doctorAvatar') %>">
                            <div class="mt-2"><%= patient.getDataValue('doctorName') %></div>
                        </div>
                        <div class="left-booking col-9 mt-3">
                            <div> Cảm ơn bạn đã đăng ký. Nhân viên bệnh viện sẽ gọi để xác nhận trong vòng 24h tới.</div>
                            <div class="mt-2">Đường dây nóng hỗ trợ: 911 911 </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Include Google Pay JavaScript library -->
<script src="https://pay.google.com/gp/p/js/pay.js"></script>
<script>
    // Initialize the Google Pay client
    const paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });

    const paymentDataRequest = {
        apiVersion: 2,
        apiVersionMinor: 0,
        allowedPaymentMethods: [{
            type: 'CARD',
            parameters: {
                allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                allowedCardNetworks: ['MASTERCARD', 'VISA'],
            },
            tokenizationSpecification: {
                type: 'PAYMENT_GATEWAY',
                parameters: {
                    gateway: 'example',
                    gatewayMerchantId: 'exampleGatewayMerchantId',
                },
            },
        }],
        merchantInfo: {
            merchantId: 'exampleMerchantId',
            merchantName: 'Example Merchant',
        },
        transactionInfo: {
            totalPriceStatus: 'FINAL',
            totalPrice: '50.00',
            currencyCode: 'USD',
        },
    };

    // Create the Google Pay button
    function createGooglePayButton() {
        const button = paymentsClient.createButton({
            onClick: onGooglePayButtonClicked,
        });
        document.getElementById('google-pay-button-container').appendChild(button);
    }

    // Handle the Google Pay button click event
    function onGooglePayButtonClicked() {
        paymentsClient.loadPaymentData(paymentDataRequest)
            .then(function(paymentData) {
                // Handle the response from Google Pay
                console.log('Payment data received:', paymentData);
                
                // Show the success page
                document.getElementById('payment-section').style.display = 'none';
                document.getElementById('success-section').style.display = 'block';
            })
            .catch(function(err) {
                console.error('Error:', err);
                alert('Payment failed. Please try again.');
            });
    }

    // Create the Google Pay button when the page loads
    window.onload = function() {
        createGooglePayButton();
    };
</script>
